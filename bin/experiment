#!/usr/bin/env ruby
require 'bundler/setup'
Bundler.require(:default)
$:.unshift(File.expand_path(File.join(__dir__, '../lib')))
require 'lima'

require 'open3'
puts OS.report

def run_a_vm(name)
  vm = Lima::VM.new
  vm.name = "rlim-#{name}"
  vm.cpus = 1
  vm.memory = 1
  vm.disk = '30'

  vm.rm!
  vm.start

  result = nil
  vm.ssh_start do |ssh|
    result = ssh.exec!('uname -a')
    puts result
  end

  vm.stop
  vm.rm!

  result
end

t = (1..2).map do |idx|
  Thread.start do
    puts "Start VM #{idx}"
    puts run_a_vm(idx.to_s)
  end
end

t.each(&:join)

# puts "Exit code: #{ww.value.exitstatus}"
#
# puts `ls -lh $HOME/.lima/rubylima/`
#
# puts File.read(vm.ssh_config_path)
#
# ssh = vm.ssh_start
#
# result = ssh.exec!('ls -lh /')
# puts result
#
# # `limactl rm -f rubylima`
